name: Phase Change Handler

# This workflow now assumes branches are created by prep-issue.sh
# It only handles PR creation/updating and status management

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  handle-phase-change:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.label.name, 'phase:') ||
      (github.event.action == 'unlabeled' && contains(github.event.label.name, 'phase:'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Auth GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Extract issue details
        id: issue-details
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          BRANCH_NAME="feature/${ISSUE_NUMBER}-$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')"
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

      - name: Determine current phase
        id: current-phase
        run: |
          LABELS='${{ toJson(github.event.issue.labels) }}'
          CURRENT_PHASE=""
          
          # Extract current phase from labels
          for label in $(echo "$LABELS" | jq -r '.[].name'); do
            if [[ $label == phase:* ]]; then
              CURRENT_PHASE=$label
              break
            fi
          done
          
          echo "current_phase=$CURRENT_PHASE" >> $GITHUB_OUTPUT
          echo "Current phase: $CURRENT_PHASE"

      - name: Verify branch exists (created by prep-issue.sh)
        run: |
          BRANCH_NAME="${{ steps.issue-details.outputs.branch_name }}"
          
          # Check if branch exists remotely
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
              echo "‚úì Branch $BRANCH_NAME exists remotely"
              git fetch origin "$BRANCH_NAME"
          else
              echo "‚ö†Ô∏è  Branch $BRANCH_NAME does not exist remotely"
              echo "   This should have been created by prep-issue.sh"
              echo "   Please run prep-issue.sh before invoking agent workflows"
              exit 1
          fi

      - name: Check if PR already exists
        id: pr-check
        run: |
          BRANCH_NAME="${{ steps.issue-details.outputs.branch_name }}"
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "")
          echo "existing_pr=$EXISTING_PR" >> $GITHUB_OUTPUT
          if [ -n "$EXISTING_PR" ]; then
            echo "‚úì PR #$EXISTING_PR already exists"
          else
            echo "‚ÑπÔ∏è  No PR exists yet, will create one for phase: ${{ steps.current-phase.outputs.current_phase }}"
          fi

      - name: phase:spec ‚Üí create/update PR for Specification phase
        if: steps.current-phase.outputs.current_phase == 'phase:spec'
        shell: bash
        env:
          ISSUE: ${{ github.event.issue.number }}
        run: |
          ISSUE_NUMBER="${{ steps.issue-details.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue-details.outputs.issue_title }}"
          BRANCH_NAME="${{ steps.issue-details.outputs.branch_name }}"
          
          # Create or update PR for Specification phase
          PR_TITLE="[Specification] Feature Spec for Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          PR_BODY="## Feature Specification for Issue #$ISSUE_NUMBER

          This PR contains the feature specification for: $ISSUE_TITLE

          **Phase:** Specification
          **Issue:** #$ISSUE_NUMBER
          **Branch:** \`$BRANCH_NAME\`

          ### Specification Document
          - üìã [Feature Specification]($SPEC_FILE)

          **Note:** This is a Specification PR. Design and Implementation will follow after specification approval.

          "

          EXISTING_PR="${{ steps.pr-check.outputs.existing_pr }}"
          
          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #$EXISTING_PR for Specification phase"
            gh pr edit "$EXISTING_PR" --title "$PR_TITLE" --body "$PR_BODY"
            gh pr edit "$EXISTING_PR" --add-label "phase:spec" --remove-label "phase:design" --remove-label "phase:tests" --remove-label "phase:impl" 
          else
            echo "Creating new PR for Specification phase"
            gh pr create --title "$PR_TITLE" --body "$PR_BODY" --base master --head "$BRANCH_NAME" --draft
            gh pr edit --add-label "phase:spec"
          fi

      - name: phase:design ‚Üí create/update PR for Design phase
        if: steps.current-phase.outputs.current_phase == 'phase:design'
        shell: bash
        env:
          ISSUE: ${{ github.event.issue.number }}
        run: |
          ISSUE_NUMBER="${{ steps.issue-details.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue-details.outputs.issue_title }}"
          BRANCH_NAME="${{ steps.issue-details.outputs.branch_name }}"
          
          # Create or update PR for Design phase
          PR_TITLE="[Design] RFC for Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          PR_BODY="## Design RFC for Issue #$ISSUE_NUMBER

          This PR contains the design RFC for: $ISSUE_TITLE

          **Phase:** Design
          **Issue:** #$ISSUE_NUMBER
          **Branch:** \`$BRANCH_NAME\`

          ### RFC Document
          - üìã [RFC Document]($RFC_FILE)

          **Note:** This is a Design PR. Implementation will follow in a separate PR after design approval.

          "

          EXISTING_PR="${{ steps.pr-check.outputs.existing_pr }}"
          
          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #$EXISTING_PR for Design phase"
            gh pr edit "$EXISTING_PR" --title "$PR_TITLE" --body "$PR_BODY"
            gh pr edit "$EXISTING_PR" --add-label "phase:design" --remove-label "phase:spec" --remove-label "phase:tests" --remove-label "phase:impl" 
          else
            echo "Creating new PR for Design phase"
            gh pr create --title "$PR_TITLE" --body "$PR_BODY" --base master --head "$BRANCH_NAME" --draft
            gh pr edit --add-label "phase:design"
          fi

      - name: phase:tests ‚Üí create/update PR for Test phase
        if: steps.current-phase.outputs.current_phase == 'phase:tests'
        run: |
          ISSUE_NUMBER="${{ steps.issue-details.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue-details.outputs.issue_title }}"
          BRANCH_NAME="${{ steps.issue-details.outputs.branch_name }}"
          
          # Create or update PR for Test phase
          PR_TITLE="[Testing] Test Cases for Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          PR_BODY="## Test cases for Issue #$ISSUE_NUMBER

          This PR contains the test cases for: $ISSUE_TITLE

          **Phase:** Tests
          **Issue:** #$ISSUE_NUMBER
          **Branch:** \`$BRANCH_NAME\`

          ### Test Cases
    

          **Note:** This is a Test PR. Implementation will follow after test approval.

          "

          EXISTING_PR="${{ steps.pr-check.outputs.existing_pr }}"
          
          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #$EXISTING_PR for Test phase"
            gh pr edit "$EXISTING_PR" --title "$PR_TITLE" --body "$PR_BODY"
            gh pr edit "$EXISTING_PR" --add-label "phase:tests" --remove-label "phase:spec" --remove-label "phase:design" --remove-label "phase:impl"
          else
            echo "Creating new PR for Test phase"
            gh pr create --title "$PR_TITLE" --body "$PR_BODY" --base master --head "$BRANCH_NAME" --draft
            gh pr edit --add-label "phase:tests"
          fi

      - name: phase:impl ‚Üí create/update PR for Implementation phase
        if: steps.current-phase.outputs.current_phase == 'phase:impl'
        run: |
          ISSUE_NUMBER="${{ steps.issue-details.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue-details.outputs.issue_title }}"
          BRANCH_NAME="${{ steps.issue-details.outputs.branch_name }}"
          
          # Create or update PR for Implementation phase
          PR_TITLE="[Implementation] Fixes for Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          PR_BODY="## Fixes for Issue #$ISSUE_NUMBER

          This PR contains the fixes for: $ISSUE_TITLE

          **Phase:** Implementation
          **Issue:** #$ISSUE_NUMBER
          **Branch:** \`$BRANCH_NAME\`

          ### Fixes
          

          Closes #$ISSUE_NUMBER

          "

          EXISTING_PR="${{ steps.pr-check.outputs.existing_pr }}"
          
          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #$EXISTING_PR for Implementation phase"
            gh pr edit "$EXISTING_PR" --title "$PR_TITLE" --body "$PR_BODY"
            gh pr edit "$EXISTING_PR" --add-label "phase:impl" --remove-label "phase:spec" --remove-label "phase:design" --remove-label "phase:tests"
          else
            echo "Creating new PR for Implementation phase"
            gh pr create --title "$PR_TITLE" --body "$PR_BODY" --base master --head "$BRANCH_NAME" --draft
            gh pr edit --add-label "phase:impl"
          fi

      - name: Normalize ISSUE and PR status to WIP (authoritative)
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-label "status:wip" --remove-label "status:needs-review" --remove-label "status:complete" || true
          
          # Use the PR number from the check step
          EXISTING_PR="${{ steps.pr-check.outputs.existing_pr }}"
          
          if [ -n "$EXISTING_PR" ]; then
            gh pr edit "$EXISTING_PR" --add-label "status:wip" --remove-label "status:needs-review" --remove-label "status:complete" || true
          fi